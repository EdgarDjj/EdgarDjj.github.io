# SSL


# SSL（Secure Socket Layer安全层套接层）

## 前言

什么是SSL，它与HTTPS中的联系？

SSL是一Secure Socket Layer，一种用于加密网络流量的加密协议。SSL处于TCP/IP模型中的应用层和传输层之间，它遵循PKCS（公钥加密标准）的客户端-服务器身份验证（通过握手和基于证书的身份验证完成），一旦建立了安全通道的消息通信（使用某些达成共识的加密标准来在发送端和接收端执行适当的加密/解密）。总之除非建立经过身份验证authenticated ，否则encrypted channel将关闭，无法进行消息通行。

HTTPS是应用层的协议在TCP/IP模型中，因此HTTPS通过SSL来进行加密。

## SSL证书

HTTPS核心的一个部分是数据传输之前的握手，握手过程确定了数据加密的密码。在握手过程中，网站会向浏览器发送SSL证书，SSL证书和我们日常用的身份证类似，是一个支持HTTPS网站的身份证明，SSL证书里面包含了网站的域名，证书的有效性，证书的颁发机构以及用于加密传输密码的公钥等信息，由于公钥加密的密码只能在申请证书生成的私钥解密，因此浏览器在生成密码之前需要先核对当前访问域名与证书上绑定的域名是否一致，同时还要对证书的颁发机构进行验证，如果验证失败，浏览器还会给出证书错误的提示。

## SSL协议的工作流程

1. 客户端的浏览器向服务器传送客户端SSL协议的版本号，加密算法的种类，产生的随机以及其他服务器与客户端之间通讯所需要的各种信息。
2. 服务器向客户端传送SSL协议的版本号，加密算法的种类，随机数以及其他相关信息，同时服务器还向客户端传送自己的证书。
3. 客户利用服务器传过来的信息验证服务器的合法性，服务器的合法性：证书是否过期，发行服务器的CA是否可靠，发行者证书的公钥能否正确解开服务器证书的“发行者的数字签名”，服务器证书上的域名是否和服务器的实际域名相匹配。如果合法性验证没有通过，通讯将断开，如果合法性验证通过，将继续进行第四步。
4. 用户端随机产生一个用于后面通讯的“对称密码”，然后用服务器的公钥（服务器的公钥从步骤中的服务器的证书中获得）对其加密，然后将加密后的“预主密码”传给服务器。
5. 如果服务器要求客户的身份认证（在握手过程中为可选），用户可以建立一个随机数然后对其进行数据签名，将这个含有签名的随机数和客户自己的证书以及加密过的”预主密码“一起传给服务器。
6. 如果服务器要求客户的身份认证，服务器必须检验客户证书和签名随机数的合法性，具体的合法性验证过程包括：客户的证书使用日期是否有效，为客户提供证书的CA 是否可靠，发行CA 的公钥能否正确解开客户证书的发行 CA 的数字签名，检查客户的证书是否在证书废止列表（CRL）中。检验如果没有通过，通讯立刻中断；如果验证通过，服务器将用自己的私钥解开加密的“预主密码”，然后执行一系列步骤来产生主通讯密码（客户端也将通过同样的方法产生相同的主通讯密码）。
7. 服务器和客户端用相同的主密码即“通话密码”，一个对称密钥用于 SSL 协议的安全数据通讯的加解密通讯。同时在 SSL 通讯过程中还要完成数据通讯的完整性，防止数据通讯中的任何变化。

8. 客户端向服务器端发出信息，指明后面的数据通讯将使用的步骤中的主密码为对称密钥，同时通知服务器客户端的握手过程结束。

9. 服务器向客户端发出信息，指明后面的数据通讯将使用的步骤中的主密码为对称密钥，同时通知客户端服务器端的握手过程结束。

10. SSL 的握手部分结束，SSL 安全通道的数据通讯开始，客户和服务器开始使用相同的对称密钥进行数据通讯，同时进行通讯完整性的检验。

## TLS（传输层）

TSL（传输层安全）是更为安全的升级版SSL。由于SSL这一术语更为常用，因此我们仍然将我们的安全证书称为SSL。

TSL/SSL 是一种加密通道的规范，它利用对称加密、公私钥不对称加密及其密钥交换算法，CA系统进行加密且可信任的信息传输在HTTP SSL中常用的对称加密算法RC4，AES，3DES等。

## SSL证书的安全问题

对HTTPS最常见的攻击手段就是SSL证书欺骗或者叫SSL劫持，是一种典型的中间人攻击。不过SSL劫持并非只是用于攻击目的，在一些特殊情况下利用SSL劫持我们可以更顺畅的访问网络，我会在后文提到。

以攻击为目的的SSL劫持如果不注意浏览器安全提示的话，很容易就中招。当网络中有中间人发起SSL劫持攻击时，攻击者需要伪造一个SSL证书发给浏览器，这个时候由于伪造的SSL证书不受信任，浏览器会给出提示。

这里有一个误区，当SSL证书不受信任的时候，并不一定就是有SSL劫持发生，有种例外情况是：一些个人网站买不起合法的SSL证书，因此会自己制作一个SSL证书来加密传输的数据。如果你经常访问某个个人网站，而且你知道这个网站是干什么的，那么这种情况可以不用担心。但是如果你访问的是网银，在线支付，或者是hotmail.com，gmail.com等，这类公司性质的网站一定会申请合法的SSL证书（12306.cn除外），一旦SSL证书不受信任，应该果断的终止访问，这个时候网络中一定会存在异常行为，对于一些小区宽带的用户一定要注意这点。

所以作为个人用户，你一定要知道你访问的是什么网站，如果你只是一个没有多少计算机只是的普通网民，我相信你不会经常上那些自己制作SSL证书的个人网站（12306.cn除外），因此如果你没有办法判断网络是不是有异常，只要是证书有问题的，干脆就别再访问了。



